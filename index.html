<html>
  <head>
    <title>ACCRETE</title>
    <meta charset="utf-8" />
    <style>
      html,
      body,
      canvas {
        position: absolute;
        top: 0;
        left: 0;
        padding: 0;
        margin: 0;
        height: 100vh;
        width: 100vw;
        z-index: 0;
      }

      button {
        position: relative;
        z-index: 1;
      }

      aside {
        display: flex;
        border-right: 2px solid black;
        border-bottom: 2px solid black;
        flex-direction: column;
        padding: 10px;
        position: relative;
        left: 0;
        top: 0;
        max-width: 180px;
        z-index: 2;
        background: white;
      }

      #planetInfo {
        position: fixed;
        right: 10px;
        top: 10px;
        max-width: 400px;
        max-height: 90vh;
        overflow-y: auto;
        background: rgba(255, 255, 255, 0.95);
        border: 2px solid black;
        padding: 15px;
        z-index: 3;
        font-family: monospace;
        font-size: 12px;
        display: none;
      }

      #planetInfo.visible {
        display: block;
      }

      #planetInfo h3 {
        margin: 0 0 10px 0;
        font-size: 14px;
        border-bottom: 1px solid #ccc;
        padding-bottom: 5px;
      }

      #planetInfo .property {
        display: flex;
        justify-content: space-between;
        margin: 3px 0;
      }

      #planetInfo .property-label {
        font-weight: bold;
        margin-right: 10px;
      }

      #planetInfo .property-value {
        text-align: right;
      }

      #planetInfo .section {
        margin-top: 15px;
        padding-top: 10px;
        border-top: 1px solid #eee;
      }

      #planetInfo .section-title {
        font-weight: bold;
        margin-bottom: 5px;
        color: #333;
      }

      aside > div {
        display: flex;
      }

      aside > div > label {
        flex: 1 1 auto;
        width: 20%;
        max-width: 40%;
      }

      canvas {
        position: absolute;
        left: 0;
        height: 100vh;
        top: 0;
        width: 100vw;
        z-index: 0;
      }
    </style>
  </head>

  <body>
    <aside>
      <div>
        <label>A</label>
        <input
          name="A"
          type="range"
          min="0.001"
          max="0.01"
          step="0.0005"
          value="0.0015"
        />
      </div>
      <div>
        <label>B</label>
        <input
          name="B"
          type="range"
          min="0.000005"
          max="0.000012"
          step="0.000001"
          value="0.000012"
        />
      </div>
      <div>
        <label>K</label>
        <input name="K" type="range" min="25" max="200" step="5" value="50" />
      </div>
      <div style="display: none">
        <label>N</label>
        <input name="N" type="range" min="3" max="3" step="0.001" value="3" />
      </div>
      <div style="display: none">
        <label>Q</label>
        <input
          name="Q"
          type="range"
          min="0.077"
          max="0.077"
          step="0.001"
          value="0.077"
        />
      </div>
      <div>
        <label>W</label>
        <input
          name="W"
          type="range"
          min="0.05"
          max="0.75"
          step="0.05"
          value="0.2"
        />
      </div>
      <div style="display: none">
        <label>α</label>
        <input name="ALPHA" type="range" min="5" max="10" step="1" value="5" />
      </div>
      <div>
        <label>Defaults</label> <input type="checkbox" name="default" />
      </div>
      <button>Generate Star System</button>
    </aside>
    <div id="planetInfo"></div>
    <canvas></canvas>
    <script>
      var accrete = new Worker("dist/accrete.worker.js");
      var canvas = document.querySelector("canvas");
      canvas.height = document.body.offsetHeight;
      canvas.width = document.body.offsetWidth;

      const hscale = Math.floor(canvas.width / 3);
      const vscale = Math.floor(canvas.height / 2);
      const rscale = canvas.width / (0.5 * canvas.height);

      var ctx = canvas.getContext("2d");
      ctx.font = "12px monospace";
      var btn = document.querySelector("button");
      var loadingInterval;
      var currentPlanets = [];
      var planetPositions = [];

      function createSystem() {
        accrete.postMessage(getConstValues());
        Array.from(document.querySelectorAll("aside input")).forEach(
          (el) => (el.disabled = true),
        );
        btn.disabled = true;
        var i = 0;

        loadingInterval = setInterval(function () {
          var l = ((e.target.innerText.match(/\.+$/) || [])[1] || "").length;
          i += 1;
          e.target.innerText =
            "Generating" + new Array(i % 4).fill(".").join("");
        }, 500);
      }

      btn.onclick = createSystem;

      function getConstValues() {
        if (document.querySelector('aside input[type="checkbox"]').checked)
          return {};
        return Array.from(document.querySelectorAll("aside input")).reduce(
          (config, el) => {
            if (el.type === "checkbox" || el.style.display === "none")
              return config;
            return Object.assign(config, { [el.name]: parseFloat(el.value) });
          },
          {},
        );
      }

      document.body.addEventListener(
        "input",
        function (e) {
          if (e.target.tagName !== "INPUT") return;
          createSystem();
        },
        true,
      );

      function showPlanetInfo(planet, planetNum) {
        const infoDiv = document.getElementById("planetInfo");

        function fmt(val, decimals = 2) {
          if (typeof val === "boolean") return val ? "Yes" : "No";
          if (typeof val === "number") return val.toFixed(decimals);
          return val;
        }

        let planetType = planet.isGasGiant ? "Gas Giant" : "Rocky Planet";
        if (!planet.isGasGiant && planet.surfacePressure > 0) {
          planetType = "Terrestrial";
        }

        let habitabilityNotes = [];
        if (
          planet.surfaceTempCelsius >= -20 &&
          planet.surfaceTempCelsius <= 50
        ) {
          habitabilityNotes.push("Temperature in habitable range");
        }
        if (planet.surfacePressure > 100 && planet.surfacePressure < 2000) {
          habitabilityNotes.push("Atmospheric pressure moderate");
        }
        if (planet.hydrosphere > 0.3 && planet.hydrosphere < 0.9) {
          habitabilityNotes.push("Significant surface water");
        }

        const html = `
          <h3>Planet ${planetNum} - ${planetType}</h3>

          <div class="section">
            <div class="section-title">Orbital Properties</div>
            <div class="property">
              <span class="property-label">Semi-major Axis:</span>
              <span class="property-value">${fmt(planet.axis, 3)} AU</span>
            </div>
            <div class="property">
              <span class="property-label">Eccentricity:</span>
              <span class="property-value">${fmt(planet.eccentricity, 3)}</span>
            </div>
            <div class="property">
              <span class="property-label">Perihelion:</span>
              <span class="property-value">${fmt(planet.perihelion, 3)} AU</span>
            </div>
            <div class="property">
              <span class="property-label">Aphelion:</span>
              <span class="property-value">${fmt(planet.aphelion, 3)} AU</span>
            </div>
            <div class="property">
              <span class="property-label">Orbital Period:</span>
              <span class="property-value">${fmt(planet.orbitalPeriod, 1)} days</span>
            </div>
            <div class="property">
              <span class="property-label">Orbital Zone:</span>
              <span class="property-value">${planet.orbitalZone === 1 ? "Inner" : planet.orbitalZone === 2 ? "Habitable" : "Outer"}</span>
            </div>
          </div>

          <div class="section">
            <div class="section-title">Physical Properties</div>
            <div class="property">
              <span class="property-label">Mass:</span>
              <span class="property-value">${fmt(planet.earthMass, 2)} M⊕</span>
            </div>
            <div class="property">
              <span class="property-label">Radius:</span>
              <span class="property-value">${fmt(planet.radius, 0)} km</span>
            </div>
            <div class="property">
              <span class="property-label">Density:</span>
              <span class="property-value">${fmt(planet.density, 2)} g/cm³</span>
            </div>
            <div class="property">
              <span class="property-label">Surface Gravity:</span>
              <span class="property-value">${fmt(planet.surfaceGravity, 2)} g</span>
            </div>
            <div class="property">
              <span class="property-label">Escape Velocity:</span>
              <span class="property-value">${fmt(planet.escapeVelocity / 100000, 1)} km/s</span>
            </div>
            <div class="property">
              <span class="property-label">Axial Tilt:</span>
              <span class="property-value">${fmt(planet.axialTilt, 1)}°</span>
            </div>
            <div class="property">
              <span class="property-label">Day Length:</span>
              <span class="property-value">${fmt(planet.dayLength, 1)} hours</span>
            </div>
          </div>

          <div class="section">
            <div class="section-title">Atmospheric Properties</div>
            <div class="property">
              <span class="property-label">Surface Pressure:</span>
              <span class="property-value">${fmt(planet.surfacePressure, 1)} mb</span>
            </div>
            <div class="property">
              <span class="property-label">Surface Temp:</span>
              <span class="property-value">${fmt(planet.surfaceTempCelsius, 1)}°C</span>
            </div>
            <div class="property">
              <span class="property-label">Greenhouse Effect:</span>
              <span class="property-value">${fmt(planet.greenhouseEffect)}</span>
            </div>
            <div class="property">
              <span class="property-label">Min Mol. Weight:</span>
              <span class="property-value">${fmt(planet.molecularWeightRetained, 1)}</span>
            </div>
            <div class="property">
              <span class="property-label">Water Boiling Pt:</span>
              <span class="property-value">${fmt(planet.boilingPoint - 273.15, 1)}°C</span>
            </div>
          </div>

          <div class="section">
            <div class="section-title">Surface Properties</div>
            <div class="property">
              <span class="property-label">Albedo:</span>
              <span class="property-value">${fmt(planet.albedo, 2)}</span>
            </div>
            <div class="property">
              <span class="property-label">Hydrosphere:</span>
              <span class="property-value">${fmt(planet.hydrosphere * 100, 1)}%</span>
            </div>
            <div class="property">
              <span class="property-label">Cloud Cover:</span>
              <span class="property-value">${fmt(planet.cloudCover * 100, 1)}%</span>
            </div>
            <div class="property">
              <span class="property-label">Ice Cover:</span>
              <span class="property-value">${fmt(planet.iceCover * 100, 1)}%</span>
            </div>
          </div>

          ${
            habitabilityNotes.length > 0
              ? `
          <div class="section">
            <div class="section-title">Habitability Notes</div>
            ${habitabilityNotes.map((note) => `<div style="margin: 3px 0;">• ${note}</div>`).join("")}
          </div>
          `
              : ""
          }
        `;

        infoDiv.innerHTML = html;
        infoDiv.className = "visible";
      }

      function drawGrid() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "black";

        for (var i = 0; i < 3; i++) {
          const offset = i * hscale;
          for (var j = 1; j <= 10; j++) {
            const x = hscale * Math.log10(j);
            let tickLen = 50;

            if (i > 0 && j === 1) {
              const label = `${Math.pow(10, i - 1)} AU`;
              ctx.fillText(
                label,
                offset + x - ctx.measureText(label).width / 2,
                canvas.height - 70,
              );
            } else {
              tickLen = 20;
            }

            ctx.beginPath();
            ctx.moveTo(offset + x, canvas.height);
            ctx.lineTo(offset + x, canvas.height - tickLen);
            ctx.stroke();
          }
        }

        ctx.stroke();
      }

      function drawPlanet(p, idx) {
        ctx.beginPath();
        ctx.fillStyle = "white";

        const au = Math.log10(p.axis);

        const rad = Math.pow(p.earthMass, 1 / 3);
        const r = Math.max(1, rad * rscale);
        const offset = au * hscale;

        const x = offset + hscale - r;
        const y = vscale - r;

        // Store planet position for click detection
        planetPositions[idx] = { x: x, y: y, r: r, planet: p, index: idx };

        const au_p =
          r * Math.log10(p.axis + (p.axis - p.perihelion) / p.axis - p.xp);
        const au_a =
          r * Math.log10(p.axis + (p.aphelion - p.axis) / p.axis + p.xa);

        const stripeScale = 2;
        const fh = Math.round((2 * r) / stripeScale);
        const hfh = fh / 2;

        ctx.arc(x, y, r, 0, 2 * Math.PI);

        if (p.isGasGiant) {
          for (var i = -hfh; i < hfh; i++) {
            const w = r * Math.cos((i / fh) * Math.PI);
            const h = r * Math.sin((i / fh) * Math.PI);
            ctx.moveTo(x - w, y + h);
            ctx.lineTo(x + w, y + h);
          }
        }

        ctx.fill();
        ctx.stroke();
        ctx.beginPath();

        ctx.moveTo(x, y + r + 50);
        ctx.lineTo(x, y + r + 10);

        ctx.moveTo(x, y + r + 50);
        ctx.lineTo(x - au_p, y + r + 50);
        ctx.lineTo(x - au_p, y + r + 10);

        ctx.moveTo(x, y + r + 50);
        ctx.lineTo(x + au_a, y + r + 50);
        ctx.lineTo(x + au_a, y + r + 10);

        ctx.stroke();

        var axisLabel = p.axis.toFixed(2) + " AU";
        var massLabel = p.earthMass.toFixed(2) + " M⊕";
        ctx.fillStyle = "black";

        ctx.fillText(
          axisLabel,
          x - ctx.measureText(axisLabel).width / 2,
          y + (idx % 2 ? -1 : 1) * (r + (idx % 2 ? 10 : 80)),
        );
        ctx.fillText(
          massLabel,
          x - ctx.measureText(massLabel).width / 2,
          y + (idx % 2 ? -1 : 1) * (r + (idx % 2 ? 20 : 90)),
        );
      }

      // Add click handler for planets
      canvas.addEventListener("click", function (e) {
        const rect = canvas.getBoundingClientRect();
        const clickX = e.clientX - rect.left;
        const clickY = e.clientY - rect.top;

        // Check if click is on any planet
        for (let i = 0; i < planetPositions.length; i++) {
          const pos = planetPositions[i];
          const dx = clickX - pos.x;
          const dy = clickY - pos.y;
          const distance = Math.sqrt(dx * dx + dy * dy);

          if (distance <= 100) {
            showPlanetInfo(pos.planet, i + 1);
            return;
          }
        }

        // Click outside any planet - hide info panel
        document.getElementById("planetInfo").className = "";
      });

      drawGrid();

      accrete.onmessage = function (e) {
        Array.from(document.querySelectorAll("aside input")).forEach(
          (el) => (el.disabled = false),
        );

        btn.disabled = false;
        btn.innerText = "Generate Star System";
        clearInterval(loadingInterval);

        const planets = e.data;
        currentPlanets = planets.sort((p1, p2) => p1.axis - p2.axis);
        planetPositions = []; // Reset positions

        var s = 50 / canvas.width;
        var inc = 100;

        drawGrid();
        console.log(currentPlanets);
        currentPlanets.map((p, i) => {
          var shade = Math.floor(
            ((0.6 * planets.length - i) / planets.length) * 255,
          );
          var rgba = [shade, shade, shade, 1];
          ctx.fillStyle = `rgba(${rgba.join(",")})`;

          drawPlanet(p, i);
        });
      };
    </script>
  </body>
</html>
